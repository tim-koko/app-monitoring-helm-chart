{{- if .Values.alerts.common.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ .Release.Name }}-k8s-alerts
  labels:
    {{- include "monitoring.labels" . | nindent 4 }}
    {{- with .Values.alerts.extraLabels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.alerts.extraAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  groups:
  - name: kubernetes-apps
    rules:
    - alert: KubePodCrashLooping
      annotations:
        description: {{` 'Pod {{ $labels.namespace }}/{{ $labels.pod }} ({{ $labels.container }}) is in waiting state (reason: "CrashLoopBackOff").' ` }}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubepodcrashlooping"
        summary: "Pod is crash looping."
      expr: |
        max_over_time(kube_pod_container_status_waiting_reason{reason="CrashLoopBackOff", namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}[5m]) >= 1
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubePodNotReady
      annotations:
        description: {{` 'Pod {{ $labels.namespace }}/{{ $labels.pod }} has been in a non-ready state for longer than 15 minutes.' `}}
        runbook_url: "https://github.com/openshift/runbooks/blob/master/alerts/cluster-monitoring-operator/KubePodNotReady.md"
        summary: "Pod has been in a non-ready state for more than 15 minutes."
      expr: |
        sum by (namespace, pod, cluster) (
          max by(namespace, pod, cluster) (
            kube_pod_status_phase{namespace="{{ .Release.Namespace }}",job="kube-state-metrics", phase=~"Pending|Unknown|Failed"}
          ) * on(namespace, pod, cluster) group_left(owner_kind) topk by(namespace, pod, cluster) (
            1, max by(namespace, pod, owner_kind, cluster) (kube_pod_owner{owner_kind!="Job"})
          )
        ) > 0
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeDeploymentGenerationMismatch
      annotations:
        description: {{` 'Deployment generation for {{ $labels.namespace }}/{{ $labels.deployment }} does not match, this indicates that the Deployment has failed but has not been rolled back.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubedeploymentgenerationmismatch"
        summary: "Deployment generation mismatch due to possible roll-back"
      expr: |
        kube_deployment_status_observed_generation{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
          !=
        kube_deployment_metadata_generation{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeDeploymentReplicasMismatch
      annotations:
        description: {{` 'Deployment {{ $labels.namespace }}/{{ $labels.deployment }} has not matched the expected number of replicas for longer than 15 minutes.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubedeploymentreplicasmismatch"
        summary: "Deployment has not matched the expected number of replicas."
      expr: |
        (
          kube_deployment_spec_replicas{namespace=~"{{ .Release.Namespace }}", job="kube-state-metrics"}
            >
          kube_deployment_status_replicas_available{namespace=~"{{ .Release.Namespace }}", job="kube-state-metrics"}
        ) and (
          changes(kube_deployment_status_replicas_updated{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}[10m])
            ==
          0
        )
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeDeploymentRolloutStuck
      annotations:
        description: {{` 'Rollout of deployment {{ $labels.namespace }}/{{ $labels.deployment }} is not progressing for longer than 15 minutes.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubedeploymentrolloutstuck"
        summary: "Deployment rollout is not progressing."
      expr: |
        kube_deployment_status_condition{namespace=~"{{ .Release.Namespace }}", condition="Progressing", status="false",job="kube-state-metrics"}
        != 0
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeStatefulSetReplicasMismatch
      annotations:
        description: {{` 'StatefulSet {{ $labels.namespace }}/{{ $labels.statefulset }} has not matched the expected number of replicas for longer than 15 minutes.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubestatefulsetreplicasmismatch"
        summary: "StatefulSet has not matched the expected number of replicas."
      expr: |
        (
          kube_statefulset_status_replicas_ready{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
            !=
          kube_statefulset_status_replicas{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
        ) and (
          changes(kube_statefulset_status_replicas_updated{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}[10m])
            ==
          0
        )
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeStatefulSetGenerationMismatch
      annotations:
        description: {{` 'StatefulSet generation for {{ $labels.namespace }}/{{ $labels.statefulset }} does not match, this indicates that the StatefulSet has failed but has not been rolled back.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubestatefulsetgenerationmismatch"
        summary: "StatefulSet generation mismatch due to possible roll-back"
      expr: |
        kube_statefulset_status_observed_generation{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
          !=
        kube_statefulset_metadata_generation{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeStatefulSetUpdateNotRolledOut
      annotations:
        description: {{` 'StatefulSet {{ $labels.namespace }}/{{ $labels.statefulset }} update has not been rolled out.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubestatefulsetupdatenotrolledout"
        summary: "StatefulSet update has not been rolled out."
      expr: |
        (
          max without (revision) (
            kube_statefulset_status_current_revision{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
              unless
            kube_statefulset_status_update_revision{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
          )
            *
          (
            kube_statefulset_replicas{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
              !=
            kube_statefulset_status_replicas_updated{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
          )
        )  and (
          changes(kube_statefulset_status_replicas_updated{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}[5m])
            ==
          0
        )
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeDaemonSetRolloutStuck
      annotations:
        description: {{` 'DaemonSet {{ $labels.namespace }}/{{ $labels.daemonset }} has not finished or progressed for at least 15 minutes.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubedaemonsetrolloutstuck"
        summary: "DaemonSet rollout is stuck."
      expr: |
        (
          (
            kube_daemonset_status_current_number_scheduled{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
             !=
            kube_daemonset_status_desired_number_scheduled{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
          ) or (
            kube_daemonset_status_number_misscheduled{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
             !=
            0
          ) or (
            kube_daemonset_status_updated_number_scheduled{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
             !=
            kube_daemonset_status_desired_number_scheduled{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
          ) or (
            kube_daemonset_status_number_available{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
             !=
            kube_daemonset_status_desired_number_scheduled{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
          )
        ) and (
          changes(kube_daemonset_status_updated_number_scheduled{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}[5m])
            ==
          0
        )
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeContainerWaiting
      annotations:
        description: {{` 'pod/{{ $labels.pod }} in namespace {{ $labels.namespace }} on container {{ $labels.container}} has been in waiting state for longer than 1 hour.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubecontainerwaiting"
        summary: "Pod container waiting longer than 1 hour"
      expr: |
        sum by (namespace, pod, container) (kube_pod_container_status_waiting_reason{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}) > 0
      for: 1h
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeDaemonSetNotScheduled
      annotations:
        description: {{` '{{ $value }} Pods of DaemonSet {{ $labels.namespace }}/{{ $labels.daemonset }} are not scheduled.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubedaemonsetnotscheduled"
        summary: "DaemonSet pods are not scheduled."
      expr: |
        kube_daemonset_status_desired_number_scheduled{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
          -
        kube_daemonset_status_current_number_scheduled{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"} > 0
      for: 10m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeDaemonSetMisScheduled
      annotations:
        description: {{` '{{ $value }} Pods of DaemonSet {{ $labels.namespace }}/{{ $labels.daemonset }} are running where they are not supposed to run.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubedaemonsetmisscheduled"
        summary: "DaemonSet pods are misscheduled."
      expr: |
        kube_daemonset_status_number_misscheduled{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"} > 0
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeJobNotCompleted
      annotations:
        description: {{` 'Job {{ $labels.namespace }}/{{ $labels.job_name }} is taking more than the configured max runtime to complete.' `}}
        summary: "Job did not complete in time"
      expr: |
        time() - max by(namespace, job_name, cluster) (kube_job_status_start_time{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
          and
        kube_job_status_active{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"} > 0) > {{ .Values.alerts.common.durations.jobMaxRuntimeSeconds | default "86400" }}
      for: 2m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeJobFailed
      annotations:
        description: {{` 'Job {{ $labels.namespace }}/{{ $labels.job_name }} failed to complete. Removing failed job after investigation should clear this alert.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubejobfailed"
        summary: "Job failed to complete."
      expr: |
        kube_job_failed{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}  > 0
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeHpaReplicasMismatch
      annotations:
        description: {{` 'HPA {{ $labels.namespace }}/{{ $labels.horizontalpodautoscaler  }} has not matched the desired number of replicas for longer than 15 minutes.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubehpareplicasmismatch"
        summary: "HPA has not matched desired number of replicas."
      expr: |
        (kube_horizontalpodautoscaler_status_desired_replicas{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
          !=
        kube_horizontalpodautoscaler_status_current_replicas{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"})
          and
        (kube_horizontalpodautoscaler_status_current_replicas{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
          >
        kube_horizontalpodautoscaler_spec_min_replicas{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"})
          and
        (kube_horizontalpodautoscaler_status_current_replicas{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
          <
        kube_horizontalpodautoscaler_spec_max_replicas{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"})
          and
        changes(kube_horizontalpodautoscaler_status_current_replicas{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}[15m]) == 0
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeHpaMaxedOut
      annotations:
        description: {{` 'HPA {{ $labels.namespace }}/{{ $labels.horizontalpodautoscaler  }} has been running at max replicas for longer than 15 minutes.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubehpamaxedout"
        summary: "HPA is running at max replicas"
      expr: |
        kube_horizontalpodautoscaler_status_current_replicas{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
          ==
        kube_horizontalpodautoscaler_spec_max_replicas{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"}
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    
  - name: kubernetes-resources
    rules:
    - alert: KubeCPUQuotaOvercommit
      annotations:
        description: {{` 'Cluster has overcommitted CPU resource requests for Namespaces.' `}}
        summary: "Cluster has overcommitted CPU resource requests."
      expr: |
        sum(min without(resource) (kube_resourcequota{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics", type="hard", resource=~"(cpu|requests.cpu)"}))
          /
        sum(kube_node_status_allocatable{resource="cpu", job="kube-state-metrics"})
          > 1.5
      for: 5m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeMemoryQuotaOvercommit
      annotations:
        description: {{` 'Cluster has overcommitted memory resource requests for Namespaces.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubememoryquotaovercommit"
        summary: "Cluster has overcommitted memory resource requests."
      expr: |
        sum(min without(resource) (kube_resourcequota{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics", type="hard", resource=~"(memory|requests.memory)"}))
          /
        sum(kube_node_status_allocatable{resource="memory", job="kube-state-metrics"})
          > 1.5
      for: 5m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeQuotaAlmostFull
      annotations:
        description: {{` 'Namespace {{ $labels.namespace }} is using {{ $value | humanizePercentage }} of its {{ $labels.resource }} quota.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubequotaalmostfull"
        summary: "Namespace quota is going to be full."
      expr: |
        kube_resourcequota{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics", type="used"}
          / ignoring(instance, job, type)
        (kube_resourcequota{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics", type="hard"} > 0)
          > 0.9 < 1
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: info
    - alert: KubeQuotaFullyUsed
      annotations:
        description: {{` 'Namespace {{ $labels.namespace }} is using {{ $value | humanizePercentage }} of its {{ $labels.resource }} quota.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubequotafullyused"
        summary: "Namespace quota is fully used."
      expr: |
        kube_resourcequota{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics", type="used"}
          / ignoring(instance, job, type)
        (kube_resourcequota{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics", type="hard"} > 0)
          == 1
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: info
    - alert: KubeQuotaExceeded
      annotations:
        description: {{` 'Namespace {{ $labels.namespace }} is using {{ $value | humanizePercentage }} of its {{ $labels.resource }} quota.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubequotaexceeded"
        summary: "Namespace quota has exceeded the limits."
      expr: |
        kube_resourcequota{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics", type="used"}
          / ignoring(instance, job, type)
        (kube_resourcequota{namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics", type="hard"} > 0)
          > 1
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
  - name: kubernetes-storage
    rules:
    - alert: KubePersistentVolumeFillingUp
      annotations:
        description: {{` 'The PersistentVolume claimed by {{ $labels.persistentvolumeclaim }} in Namespace {{ $labels.namespace }} {{ with $labels.cluster -}} on Cluster {{ . }} {{- end }} is only {{ $value | humanizePercentage }} free.' `}}
        runbook_url: https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubepersistentvolumefillingup
        summary: "PersistentVolume is filling up."
      expr: |
        (
          kubelet_volume_stats_available_bytes{namespace=~"{{ .Release.Namespace }}",job="kubelet", metrics_path="/metrics"}
            /
          kubelet_volume_stats_capacity_bytes{namespace=~"{{ .Release.Namespace }}",job="kubelet", metrics_path="/metrics"}
        ) < 0.10
        and
        kubelet_volume_stats_used_bytes{namespace=~"{{ .Release.Namespace }}",job="kubelet", metrics_path="/metrics"} > 0
        unless on(namespace, persistentvolumeclaim)
        kube_persistentvolumeclaim_access_mode{namespace=~"{{ .Release.Namespace }}", access_mode="ReadOnlyMany"} == 1
        unless on(namespace, persistentvolumeclaim)
        kube_persistentvolumeclaim_labels{namespace=~"{{ .Release.Namespace }}",label_alerts_k8s_io_kube_persistent_volume_filling_up="disabled"} == 1
      for: 1m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: critical
    - alert: KubePersistentVolumeFillingUp
      annotations:
        description: {{` 'Based on recent sampling, the PersistentVolume claimed by {{ $labels.persistentvolumeclaim }} in Namespace {{ $labels.namespace }} {{ with $labels.cluster -}} on Cluster {{ . }} {{- end }} is expected to fill up within four days. Currently {{ $value | humanizePercentage }} is available.' `}}
        runbook_url: https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubepersistentvolumefillingup
        summary: "PersistentVolume is filling up."
      expr: |
        (
          kubelet_volume_stats_available_bytes{namespace=~"{{ .Release.Namespace }}",job="kubelet", metrics_path="/metrics"}
            /
          kubelet_volume_stats_capacity_bytes{namespace=~"{{ .Release.Namespace }}",job="kubelet", metrics_path="/metrics"}
        ) < 0.20
        and
        kubelet_volume_stats_used_bytes{namespace=~"{{ .Release.Namespace }}",job="kubelet", metrics_path="/metrics"} > 0
        and
        predict_linear(kubelet_volume_stats_available_bytes{namespace=~"{{ .Release.Namespace }}",job="kubelet", metrics_path="/metrics"}[6h], 4 * 24 * 3600) < 0
        unless on(namespace, persistentvolumeclaim)
        kube_persistentvolumeclaim_access_mode{namespace=~"{{ .Release.Namespace }}", access_mode="ReadOnlyMany"} == 1
        unless on(namespace, persistentvolumeclaim)
        kube_persistentvolumeclaim_labels{namespace=~"{{ .Release.Namespace }}",label_alerts_k8s_io_kube_persistent_volume_filling_up="disabled"} == 1
      for: 1h
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubePersistentVolumeInodesFillingUp
      annotations:
        description: {{` 'The PersistentVolume claimed by {{ $labels.persistentvolumeclaim }} in Namespace {{ $labels.namespace }} {{ with $labels.cluster -}} on Cluster {{ . }} {{- end }} only has {{ $value | humanizePercentage }} free inodes.' `}}
        runbook_url: https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubepersistentvolumeinodesfillingup
        summary: "PersistentVolumeInodes are filling up."
      expr: |
        (
          kubelet_volume_stats_inodes_free{namespace=~"{{ .Release.Namespace }}",job="kubelet"}
            /
          kubelet_volume_stats_inodes{namespace=~"{{ .Release.Namespace }}",job="kubelet"}
        ) < 0.03
        and
        kubelet_volume_stats_inodes_used{namespace=~"{{ .Release.Namespace }}",job="kubelet"} > 0
        unless on(cluster, namespace, persistentvolumeclaim)
        kube_persistentvolumeclaim_access_mode{namespace=~"{{ .Release.Namespace }}", access_mode="ReadOnlyMany"} == 1
        unless on(cluster, namespace, persistentvolumeclaim)
        kube_persistentvolumeclaim_labels{namespace=~"{{ .Release.Namespace }}",label_excluded_from_alerts="true"} == 1
      for: 1m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: critical
    - alert: KubePersistentVolumeInodesFillingUp
      annotations:
        description: {{` 'Based on recent sampling, the PersistentVolume claimed by {{ $labels.persistentvolumeclaim }} in Namespace {{ $labels.namespace }} {{ with $labels.cluster -}} on Cluster {{ . }} {{- end }} is expected to run out of inodes within four days. Currently {{ $value | humanizePercentage }} of its inodes are free.' `}}
        runbook_url: https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubepersistentvolumeinodesfillingup
        summary: "PersistentVolumeInodes are filling up."
      expr: |
        (
          kubelet_volume_stats_inodes_free{namespace=~"{{ .Release.Namespace }}",job="kubelet"}
            /
          kubelet_volume_stats_inodes{namespace=~"{{ .Release.Namespace }}",job="kubelet"}
        ) < 0.15
        and
        kubelet_volume_stats_inodes_used{namespace=~"{{ .Release.Namespace }}",job="kubelet"} > 0
        and
        predict_linear(kubelet_volume_stats_inodes_free{namespace=~"{{ .Release.Namespace }}",job="kubelet"}[6h], 4 * 24 * 3600) < 0
        unless on(cluster, namespace, persistentvolumeclaim)
        kube_persistentvolumeclaim_access_mode{namespace=~"{{ .Release.Namespace }}", access_mode="ReadOnlyMany"} == 1
        unless on(cluster, namespace, persistentvolumeclaim)
        kube_persistentvolumeclaim_labels{namespace=~"{{ .Release.Namespace }}",label_excluded_from_alerts="true"} == 1
      for: 1h
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubePersistentVolumeErrors
      annotations:
        description: {{` 'The persistent volume {{ $labels.persistentvolume }} has status {{ $labels.phase }}.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubepersistentvolumeerrors"
        summary: "PersistentVolume is having issues with provisioning."
      expr: |
        kube_persistentvolume_status_phase{phase=~"Failed|Pending",namespace=~"{{ .Release.Namespace }}",job="kube-state-metrics"} > 0
      for: 5m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
  - name: kubernetes-general-application
    rules:
    - alert: ThrottledContainers
      annotations:
        message: {{` 'Container {{ $labels.namespace }}/{{ $labels.pod }} has been throttled {{ $value }} of its time for longer than 15 minutes.' `}}
        summary: "Container is being throttled, this might be an indication for performance issues."
      expr: |
        rate(container_cpu_cfs_throttled_seconds_total{namespace=~"{{ .Release.Namespace }}"}[10m])
        > {{ .Values.alerts.common.thresholds.throttlingThreshold }}
      for: 15m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubePodRestarting
      annotations:
        message: {{` "Pod {{$labels.pod}} in namespace {{$labels.namespace}}: restart\
          \ count in the last 15 minutes is higher than 3. Current value is: {{$value}}'"` }}
        summary: "high pod restart count, might cause high load on the platform"
      expr: |
        increase(kube_pod_container_status_restarts_total{namespace="{{ .Release.Namespace }}"}[15m]) > 3
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: warning
    - alert: KubeDeploymentReplicasNotReady
      annotations:
        description: {{` 'Deployment {{ $labels.namespace }}/{{ $labels.deployment }} has had 0 replicas available for longer than 10 minutes.' `}}
        runbook_url: "https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubedeploymentreplicasmismatch"
        summary: "Zero Pods of the Deployment have become available"
      expr: |
        (
          (kube_deployment_spec_replicas{namespace=~"{{ .Release.Namespace }}", job="kube-state-metrics"} > 0 )
            and
          (kube_deployment_status_replicas_available{namespace=~"{{ .Release.Namespace }}", job="kube-state-metrics"} == 0)
        ) and (
          changes(kube_deployment_status_replicas_updated{namespace=~"{{ .Release.Namespace }}", job="kube-state-metrics"}[10m])
            ==
          0
        )
      for: 10m
      labels:
        {{- with .Values.alerts.extraAlertLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        severity: critical
{{- end }}